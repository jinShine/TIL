# 3.MSW(

### MSW (Mock Service Worker)

> [MSW](https://mswjs.io/)\
> [Service Worker API](https://developer.mozilla.org/ko/docs/Web/API/Service\_Worker\_API)\
> [ì•„ìƒ¬ì˜ Mock Service Worker (MSW)](https://github.com/ahastudio/til/blob/main/mock-api/msw.md)\
> [Mocking REST API](https://mswjs.io/docs/getting-started/mocks/rest-api)\
> [Integrate mocking into Node](https://mswjs.io/docs/getting-started/integrate/node)

ì½”ë“œ ë ˆë²¨ì´ ì•„ë‹ˆë¼ ë„¤íŠ¸ì›Œí¬ ë ˆë²¨ì—ì„œ ê°€ì§œ êµ¬í˜„. ì˜¤í”„ë¼ì¸ ì‘ì—… ë“±ì„ ì§€ì›í•˜ê¸° ìœ„í•œ ì„œë¹„ìŠ¤ ì›Œì»¤ì˜ ê¸°ëŠ¥ì„ ìœ ìš©íˆ í™œìš©í•œ ê²ƒ.

MSW íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
npm i -D msw
```

`jest.config.js` íŒŒì¼ì˜ â€œsetupFilesAfterEnvâ€ ì†ì„±ì— `setupTests.ts` íŒŒì¼ ì¶”ê°€.

```jsx
module.exports = {
	testEnvironment: 'jsdom',
	**setupFilesAfterEnv**: [
		'@testing-library/jest-dom/extend-expect',
		'**<rootDir>/src/setupTests.ts**',
	],
	transform: {
		'^.+\\\\.(t|j)sx?$': ['@swc/jest', {
			jsc: {
				parser: {
					syntax: 'typescript',
					jsx: true,
					decorators: true,
				},
				transform: {
					react: {
						runtime: 'automatic',
					},
				},
			},
		}],
	},
};
```

`src/setupTests.ts` íŒŒì¼

```jsx
import server from './mocks/server';

beforeAll(() => server.listen({ onUnhandledRequest: 'error' }));

afterAll(() => server.close());

afterEach(() => server.resetHandlers());
```

`src/mocks/server.ts` íŒŒì¼

```jsx
import { setupServer } from 'msw/node';

import handlers from './handlers';

const server = setupServer(...handlers);

export default server;
```





### REST API ëª¨í‚¹í•˜ê¸°



**í´ë” êµ¬ì¡°**

```
â”œâ”€â”€ package.json
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ jest.config.js âœ…
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ main.tsx
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ App.test.tsx âœ…
â”‚   â”œâ”€â”€ setupTests.ts âœ…
â”‚   â”œâ”€â”€ components ğŸ“
â”‚   â”œâ”€â”€ hooks ğŸ“
â”‚   â”œâ”€â”€ mocks ğŸ“
â”‚   â”‚   â”œâ”€â”€ handlers.ts âœ…
â”‚   â”‚   â””â”€â”€ server.ts âœ…
```



**handlers.ts íŒŒì¼ ì‘ì„±**

`ì§„ì§œê°™ì€ ê²ƒ`ì´ì§€ `ì§„ì§œ`ê°€ ì•„ë‹˜\
ì§„ì§œë„ í…ŒìŠ¤íŠ¸ê°€ í•„ìš”í•¨ â‡’ **E2E í…ŒìŠ¤íŠ¸**

```ts
// src/mocks/handlers.ts 

import {rest} from 'msw';
// import fixtures from '../../fixtures';

const BASE_URL = 'http://localhost:3000';

const handlers = [
    rest.get(`${BASE_URL}/products`, (req, res, ctx) => {
        // const { products } = fixtures; // fixturesë¥¼ ì‚¬ìš©í•´ë„ ë¨  
        const products = [
            {
                category: 'Fruits', price: '$1', stocked: true, name: 'Apple',
            },
        ];

        return res(
            ctx.status(200), // ì—†ì–´ë„ ë¨(ê¸°ë³¸ ì„¤ì •ì´ 200)
            ctx.json({products}), // ìœ„ì˜ ìš”ì²­ì„ ì´ í˜•íƒœë¡œ ë°˜í™© 
        );
    }),
];

export default handlers;
```

\
**App.test.ts íŒŒì¼ ìˆ˜ì •**

```ts
// App.test.ts

import {render, screen, waitFor} from '@testing-library/react';

import App from './App';

// jest.mock ë¶ˆí•„ìš”

test('App', async () => {
    render(<App / >);

    await waitFor(() => {
        screen.getByText('Apple');
    });
});
```

* waitFor : \~ ê°€ ë  ë•Œê¹Œì§€ ëŒ€ê¸°
  * ì½œë°±í•¨ìˆ˜ì˜ íƒ€ì…ì´ Promiseë¡œ ë˜ì–´ ìˆì–´ì„œ async/await í•„ìš”



**ì£¼ì˜ì  & polyfill ì´ìš©í•˜ê¸°**

```ts
// hooks/useFetchProducts.ts

export default function useFetchProducts() {
    const url = 'http://localhost:3000/products';
    const {data, error} = useFetch<ProductsResult>(url);
    console.log({error});
    if (!data) {
        return [];
    }

    return data.products;
}
```

```
ğŸš¨ error: ReferenceError: fetch is not defined
```

fetchëŠ” ìœˆë„ìš°ì— ìˆëŠ” ê²ƒ\
ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë˜ì§€ë§Œ Nodeì—ì„œëŠ” ì˜¤ë¥˜\
Node ìµœì‹  ë²„ì „ì€ fetchë¥¼ ì§€ì›í•˜ì§€ë§Œ, í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ Node ë²„ì „ì—ì„œëŠ” ì§€ì› X

â‡’ **polyfill(í´ë¦¬í•„)** ì„ ì´ìš©í•´ í•´ê²°

[GitHubì—ì„œ ë§Œë“  fetch polyfill](https://github.com/github/fetch)

#### ì„¤ì¹˜

```
npm i -D whatwg-fetch
```

#### `setupTests.ts` íŒŒì¼ì— import

```
import 'whatwg-fetch'
```

#### `hooks/useFetchProducts.ts` íŒŒì¼ ì›ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°

```ts
export default function useFetchProducts() {
    const url = 'http://localhost:3000/products';
    const {data} = useFetch<ProductsResult>(url);
    if (!data) {
        return [];
    }

    return data.products;
}
```

\


#### polyfill(í´ë¦¬í•„)

[MDN - Polyfill](https://developer.mozilla.org/ko/docs/Glossary/Polyfill)\
[ëª¨ë˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ - í´ë¦¬í•„](https://ko.javascript.info/polyfills)\
[GitHubì—ì„œ ë§Œë“  fetch polyfill](https://github.com/github/fetch)

ê¸°ë³¸ì ìœ¼ë¡œ ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ì „ ë¸Œë¼ìš°ì €ì—ì„œ **ìµœì‹  ê¸°ëŠ¥**ì„ ì œê³µí•˜ëŠ” ë° í•„ìš”í•œ ì½”ë“œ (ì¼ë°˜ì ìœ¼ë¡œ ì›¹ì˜ JavaScript)

ìë°”ìŠ¤í¬ë¦½íŠ¸ ì—”ì§„ì„ ë§Œë“œëŠ” ê° ì¡°ì§ì€ ë‚˜ë¦„ëŒ€ë¡œ ìš°ì„ ìˆœìœ„ë¥¼ ë§¤ê²¨ ëª…ì„¸ì„œ ë‚´ ì–´ë–¤ ê¸°ëŠ¥ì„ ë¨¼ì € êµ¬í˜„í• ì§€ ê²°ì •\
ëª…ì„¸ì„œì— ë“±ë¡ëœ ê¸°ëŠ¥ë³´ë‹¤ ì´ˆì•ˆ(draft)ì— ìˆëŠ” ì œì•ˆì„ ë¨¼ì € êµ¬í˜„í•˜ê¸°ë¡œ ê²°ì •í•˜ëŠ” ê²½ìš°ë„ ì¡´ì¬\
êµ¬í˜„ ë‚œë„ê°€ ë†’ì•„ì„œ ì´ëŸ° ê²°ì •ì„ ë‚´ë¦¬ëŠ” ê²½ìš°ë„ ìˆì§€ë§Œ, êµ¬ë¯¸ë¥¼ ë‹¹ê¸°ì§€ ì•Šì•„ ì´ëŸ° ê²°ì •ì„ ë‚´ë¦¬ê¸°ë„ í•¨\
ì—”ì§„ì´ **í‘œì¤€ ì „ì²´ë¥¼ ì§€ì›í•˜ì§€ ì•Šê³  ì¼ë¶€ë§Œ ì§€ì›**í•˜ëŠ” ê²ƒì€ í”í•œ ì¼
